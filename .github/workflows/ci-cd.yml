name: CI/CD Pipeline

# 1. Trigger the workflow on pushes to the main branch
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from the GitHub Actions tab

# Global Environment Variables for Image Naming
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/backend # e.g., barakidg/simple-fullstack-website/backend
  BACKEND_DIR: simple backend # Match your actual folder name

jobs:
  # 2. Build and Push Job
  build-and-push-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Necessary to push images to GHCR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Set up QEMU for multi-platform builds (not strictly necessary but good practice)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      # Set up Docker Buildx (required for modern builds)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Log in to GitHub Container Registry (GHCR)
      - name: Log in to the Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }} # Your GitHub username
          # GHCR uses the automatically generated GITHUB_TOKEN for authentication
          password: ${{ secrets.GITHUB_TOKEN }} 

      # Build and Push the Docker image
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ env.BACKEND_DIR }} # Uses your "simple backend" folder
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          # This creates a "latest" tag and pushes it to GHCR